---
title: macOS 15.4ã§sqlcã®ãƒ“ãƒ«ãƒ‰ã«å¤±æ•—ã™ã‚‹åŸå› ã¨å¯¾ç­–
emoji: "ğŸ•"
type: "tech"
topics: ["Go"]
published: false
---

macOS 15.4ç’°å¢ƒã§ [sqlc](https://docs.sqlc.dev/en/latest/) ã‚’ãƒ“ãƒ«ãƒ‰ã—ã‚ˆã†ã¨ã—ãŸéš›ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ãƒ“ãƒ«ãƒ‰ã«å¤±æ•—ã™ã‚‹ç¾è±¡ã«é­é‡ã—ã¾ã—ãŸã€‚æœ¬è¨˜äº‹ã§ã¯ã€ãã®åŸå› ã¨è§£æ±ºç­–ã«ã¤ã„ã¦ã¾ã¨ã‚ã¾ã™ã€‚

## ç™ºç”Ÿã—ãŸã‚¨ãƒ©ãƒ¼

ä»¥ä¸‹ã¯ã€`sqlc` ãƒãƒ¼ã‚¸ãƒ§ãƒ³1.28.0ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã‚ˆã†ã¨ã—ãŸéš›ã«è¡¨ç¤ºã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ã§ã™ã€‚

```shell
$ go install github.com/sqlc-dev/sqlc/cmd/sqlc@v1.28.0
# github.com/pganalyze/pg_query_go/v5/parser
src_port_snprintf.c:374:1: error: static declaration of 'strchrnul' follows non-static declaration
/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/include/_string.h:198:9: note: previous declaration is here
src_port_snprintf.c:438:27: warning: 'strchrnul' is only available on macOS 15.4 or newer [-Wunguarded-availability-new]
/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/include/_string.h:198:9: note: 'strchrnul' has been marked as being introduced in macOS 15.4 here, but the deployment target is macOS 15.0.0
src_port_snprintf.c:438:27: note: enclose 'strchrnul' in a __builtin_available check to silence this warning
```

ãªãŠã€[`v1.29.0`](https://github.com/sqlc-dev/sqlc/releases/tag/v1.29.0) ä»¥é™ã§ã¯ã“ã®å•é¡Œã¯è§£æ¶ˆã•ã‚Œã¦ãŠã‚Šã€æ­£å¸¸ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™ã€‚

```shell
$ go install github.com/sqlc-dev/sqlc/cmd/sqlc@v1.29.0
# => æˆåŠŸã—ã¾ã™
```

## æ¤œè¨¼ç’°å¢ƒ

- OS: macOS Sequoia 15.4.1 arm64
- Host: MacBook Air (M1, 2020)

## åŸå› 

ã“ã®å•é¡Œã¯ã€`pg_query_go` ã¨ã„ã†ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã€macOS 15.4ã§æ–°ãŸã«è¿½åŠ ã•ã‚ŒãŸ `strchrnul()` é–¢æ•°ã‚’åˆ©ç”¨ã—ã‚ˆã†ã¨ã—ãŸã“ã¨ã«èµ·å› ã—ã¦ã„ã¾ã™ã€‚
å®Ÿéš›ã€[sqlcã®Issue #3916](https://github.com/sqlc-dev/sqlc/issues/3916) ã‚„ [pg_query_goã®Issue #132](https://github.com/pganalyze/pg_query_go/issues/132) ã§ã‚‚å ±å‘Šã•ã‚Œã¦ãŠã‚Šã€ã™ã§ã«ä¿®æ­£ã•ã‚Œã¦ã„ã¾ã™ã€‚

ç›´æ¥çš„ãªåŸå› ã¯PostgreSQLæœ¬ä½“ã®`configure`ãƒã‚§ãƒƒã‚¯ã®èª¤ã‚Šã§ã—ãŸã€‚
macOS 15.4ã§ã¯`strchrnul()`é–¢æ•°ãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã—ãŸãŒã€ã“ã®é–¢æ•°ã¯`MACOSX_DEPLOYMENT_TARGET >= 15.4`ã¨ã„ã†æ¡ä»¶ä¸‹ã§ã®ã¿åˆ©ç”¨ã§ãã¾ã™ã€‚
ãƒ‡ãƒ•ãƒ•ã‚©ãƒ«ãƒˆã§ã¯`MACOSX_DEPLOYMENT_TARGET` ã¯ `15.0` ã«å›ºå®šã•ã‚Œã‚‹ãŸã‚ã€15.4 ã®æ–°APIã¯æœ¬æ¥åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚
ã—ã‹ã—ã€å¾“æ¥ã®`configure`ã§ã¯é–¢æ•°ã®å­˜åœ¨ã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã‚‹ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼ˆ15.0ï¼‰ã®ã¾ã¾ã§ã‚‚ä½¿ãˆã‚‹ã¨åˆ¤æ–­ã—ã¦ã—ã¾ã„ã€å®Ÿéš›ã®ãƒªãƒ³ã‚¯ã‚„ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§æœªå®šç¾©ã‚·ãƒ³ãƒœãƒ«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã€ãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ã¾ã™ã€‚

ã“ã‚Œã¯ [ã“ã¡ã‚‰ã®ã‚³ãƒŸãƒƒãƒˆ](https://github.com/postgres/postgres/commit/6da2ba1d8a031984eb016fed6741bb2ac945f19d) ã§ä¿®æ­£ã•ã‚Œã¦ã„ã¾ã™ã€‚

> Fix detection and handling of strchrnul() for macOS 15.4.
>
> As of 15.4, macOS has strchrnul(), but access to it is blocked behind
> a check for MACOSX_DEPLOYMENT_TARGET >= 15.4.  But our does-it-link
> configure check finds it, so we try to use it, and fail with the
> present default deployment target (namely 15.0).  This accounts for
> today's buildfarm failures on indri and sifaka.

ã“ã®ä¿®æ­£ã¯ [pganalyze/libpg_query 17-6.1.0](https://github.com/pganalyze/libpg_query/releases/tag/17-6.1.0) ã§å–ã‚Šè¾¼ã¾ã‚Œã¦ã„ã¾ã™ã€‚
> Update to Postgres 17.4, and add recent patches scheduled for Postgres 17.5 (not yet released)
> Notably, this pulls in support for macOS 15.4 which defines strchrnul in its standard library, fixing builds on up-to-date macOS versions.

## è§£æ±ºç­–

### 1. ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æœ€æ–°ã«ã™ã‚‹

æœ€ã‚‚ç°¡å˜ãªè§£æ±ºç­–ã¯ã€`sqlc`ã‚„`pg_query_go`ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æœ€æ–°ã«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã™ã‚‹ã“ã¨ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€macOS 15.4ã§ã‚‚å•é¡Œãªããƒ“ãƒ«ãƒ‰ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

### 2. ãƒ“ãƒ«ãƒ‰ãƒ•ãƒ©ã‚°ã‚’æŒ‡å®šã™ã‚‹

ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ãŒé›£ã—ã„å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«CGOã®ãƒ•ãƒ©ã‚°ã‚’è¨­å®šã—ã€æ˜ç¤ºçš„ã«macOS 15.4ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã—ã¦ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã“ã¨ã§å›é¿ã§ãã¾ã™ã€‚

```bash
export CGO_CFLAGS="-DHAVE_STRCHRNUL -mmacosx-version-min=15.4"
export MACOSX_DEPLOYMENT_TARGET="15.4"
```

## å‚è€ƒãƒªãƒ³ã‚¯
- [The tool stopped working on MacOS 15.4 Â· Issue #3916 Â· sqlc-dev/sqlc](https://github.com/sqlc-dev/sqlc/issues/3916)
- [Builds are broken on MacOS 15.4 Â· Issue #132 Â· pganalyze/pg_query_go](https://github.com/pganalyze/pg_query_go/issues/132)
- [Fix detection and handling of strchrnul() for macOS 15.4. Â· postgres/postgres@6da2ba1](https://github.com/postgres/postgres/commit/6da2ba1d8a031984eb016fed6741bb2ac945f19d)
