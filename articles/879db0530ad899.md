---
title: "git worktreeを使った開発を便利にする私のtmux設定とgit util集"
emoji: "🌊"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["tmux", "terminal", "zsh", "git"]
published: false
---

私は普段 Alacritty + tmux + Neovim で開発しています。
ターミナル上での操作を快適にするためにキーバインドやutiltityに

まずは、ベースとなっている `tmux.conf` の全体像です。

```text
set -g prefix C-q
unbind C-b

# window の移動をOption + h,l
# window の作成をOption + n
# window の並び替えをShift + Option + n
bind -n M-l next-window
bind -n M-h previous-window
bind -n M-n new-window -c "#{pane_current_path}"
bind -n M-\' "swap-window -t +1 \; select-window -t +1"
bind -n M-\; "swap-window -t -1 \; select-window -t -1"

# pane の分割
bind -n M-v split-window -h -c "#{pane_current_path}"
bind -n M-s split-window -v -c "#{pane_current_path}"

# 全ペインに送信
bind e setw synchronize-panes on
bind E setw synchronize-panes off

# 外観
## 利用できる色一覧を調べるコマンド
## for i in {0..255}; do printf "\x1b[38;5;${i}mcolour${i}\x1b[0m\n"; done | column -x

## Alacrittyでtrue colorにする(https://github.com/alacritty/alacritty/issues/109)
set -g default-terminal "xterm-256color"
set-option -sa terminal-overrides ',alacritty:RGB'

## deltaでtrue colorを有効にする(https://dandavison.github.io/delta/using-delta-with-tmux.html)
set -ga terminal-overrides ",xterm-256color:Tc"



# popupでコマンドを実行する
bind g popup -w90% -h90% -d '#{pane_current_path}' -E 'tig'
bind C-p popup -w90% -h90% -d '#{pane_current_path}' -E 'pet search | pbcopy'
bind t popup -w90% -h90% -d '#{pane_current_path}' -E 'fzf | pbcopy'


# List of plugins
%hidden TMUX_DATA_HOME='~/.local/share/tmux'
%hidden TMUX_PLUGIN_MANAGER_PATH='#{TMUX_DATA_HOME}/plugins'
set-environment -g TMUX_PLUGIN_MANAGER_PATH '~/.local/share/tmux/plugins'
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-open'
set -g @plugin 'tmux-plugins/tmux-copycat'

# https://github.com/sainnhe/tmux-fzf prefix + F (Shift+F).
TMUX_FZF_LAUNCH_KEY="C-f"
set -g @plugin 'sainnhe/tmux-fzf'
bind f run-shell -b "#{TMUX_PLUGIN_MANAGER_PATH}/tmux-fzf/scripts/window.sh switch"

set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @resurrect-dir '~/.local/share/tmux/resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @continuum-save-interval '15'
set -g @continuum-restore 'on'

# tmuxのwindow名を、git repositoryにする
set -g @plugin "ikorihn/tmux-rename-window-project"

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
if "test ! -d #{TMUX_PLUGIN_MANAGER_PATH}/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm #{TMUX_PLUGIN_MANAGER_PATH}/tpm && #{TMUX_PLUGIN_MANAGER_PATH}/tpm/bin/install_plugins'"
run-shell "#{TMUX_PLUGIN_MANAGER_PATH}/tpm/tpm"
```

---

## Prefixを `C-q` にして左手の負担を減らす
デフォルトの `C-b` は私の手には少し遠いため、ホームポジションから最小限の動きで押せる `C-q` をPrefixにしています。これだけで操作のテンポが一段上がります。

## Optionキーをフル活用したWindow操作
Prefixキー（`C-q`）を押してからキーを叩く、という2ステップの操作を減らすため、Windowの移動や作成には `Option (Meta)` キーとの組み合わせを割り当てています。

- `Option + l / h`: 前後のWindowへ。ブラウザのタブを切り替えるような感覚で移動できます。
- `Option + n`: 新しいWindowを、現在のディレクトリを維持したまま開きます。

この「Prefixを介さない操作」を増やすことで、思考を中断させずにターミナル内を動けるようになります。

## 表示の美しさと視認性
私は Alacritty をメインのターミナルとして利用しており、tmux 越しでも `delta` などのツールが持つ本来の色味（True Color）を表示できるように設定しています。
視覚的なストレスを減らすことも、長時間開発を続ける上では重要な要素だと考えています。

## Popup機能を「一時的なツール呼び出し」に使う
tmux 3.2 から導入された **Popup機能** は、私の開発フローを大きく変えました。

- `Prefix + g` (tig): コードを書きながら「今の変更差分を確認したい」「一部だけコミットしたい」と思ったときに、画面を切り替えずにその場で `tig` を呼び出せます。
- `Prefix + t`: `pet` でスニペットを探したり、`fzf` でファイルを検索したりといった「ちょっとした作業」をポップアップで行い、終わればすぐに元のコードに戻れます。

現在のコンテキスト（エディタの画面など）を維持したまま、別レイヤーでツールを扱えるのが非常に強力です。


## Window名で「今どこにいるか」を迷わない
複数のプロジェクトを同時に進めていると、「どのWindowがどのリポジトリだったか」が分からなくなることがあります。
そこで自作した [ikorihn/tmux-rename-window-project](https://github.com/ikorihn/tmux-rename-window-project) というプラグインを使い、Window名を自動的にカレントディレクトリのGitリポジトリ名にするようにしています。これで、Window一覧を見るだけで一瞬で目的の場所に飛べるようになりました。


## fzf-tmux でコマンドライン操作もポップアップ化
`fzf` を tmux のポップアップ内で実行できる `fzf-tmux` も愛用しています。
これを利用すると、シェルスクリプトから呼び出す `fzf` を画面中央にポップアップとして表示でき、非常にモダンな操作感になります。

以下は私が実際に zsh で利用している、`fzf-tmux` を活用した便利関数の一部です。

### ghq + fzf-tmux でリポジトリ移動
`ghq` で管理しているリポジトリをポップアップで選択して移動します。
```bash
# ghq + cd
gcd() {
  local root=$(ghq root)
  local repo=$(ghq list | fzf-tmux $FZF_TMUX_OPTS --preview="ls -AF ${root}/{1}")
  if [[ -z $repo ]]; then
    return
  fi
  local fullpath="${root}/${repo}"
  cd $fullpath
  zle accept-line
  zle reset-prompt
}
```


### Git Branch / Worktree 操作
ブランチの切り替えや、Git Worktree を使っている場合にそのディレクトリへ移動する機能です。
```bash
fbr() {
  branch_line=$(git branch -vv | fzf-tmux $FZF_TMUX_OPTS +m)
  branch=$(echo "$branch_line" | awk '{print $1}')
  if [[ "$branch" == "" || "$branch" == "*" ]]; then
    return
  fi

  if [[ "$branch" == "+" ]]; then
    # Worktreeの場合はそのディレクトリへ移動
    branch=$(echo "$branch_line" | awk '{print $2}')
    worktree="$(git worktree list | rg -F "[${branch}]" | awk '{print $1}')"
    cd "${worktree}"
    zle accept-line
    return
  fi

  res=$(git stash)
  git switch $branch
  if [[ ! $res =~ "No local changes" ]]; then
    git stash pop
  fi
}
```

remoteのbranchをcheckoutするコマンド
```bash
fbrm() {
  branch=$(git branch -r | fzf +m | sed 's#^ *origin/##')
  if [[ "$branch" == "" || "$branch" == "*" ]]; then
    return
  fi

  res=$(git stash)
  git switch $branch
  if [[ ! $res =~ "No local changes" ]]; then
    git stash pop
  fi
}
```

ブランチとworktreeをまとめて削除するコマンド
```bash
fbrd() {
  local force
  while getopts "f" opt; do
    case $opt in
      f)
        force="-f"
        ;;
    esac
  done

  git branch -vv | fzf -m | while read -r branch_line; do
    branch=$(echo "$branch_line" | awk '{print $1}')
    if [[ "$branch" == "" || "$branch" == "*" ]]; then
      return
    fi

    if [[ "$branch" == "+" ]]; then
      # If the branch is a worktree, remove worktree before deleting branch
      branch=$(echo "$branch_line" | awk '{print $2}')
      worktree="$(git worktree list | rg -F "[${branch}]" | awk '{print $1}')"
      git worktree remove ${force:-} "${worktree}"
    fi

    git branch -D "$branch"
  done
}
```

## Worktree関連

```bash
gitroot() {
  local dir=${1:-$(pwd)}
  if git -C $dir rev-parse --is-inside-work-tree 2>/dev/null 1>/dev/null; then
    echo $(git -C $dir rev-parse --show-toplevel)
  else
    echo $dir
  fi
}
```

git repositoryの各作業ツリーのルートディレクトリおよび、worktree中央のgitディレクトリに移動するコマンド
```bash
groot() {
  cd $(gitroot $(pwd))
}

gwroot() {
  cd $(dirname $(git rev-parse --git-common-dir))
}
```

## おわりに
tmuxの設定は、自分が「どう動きたいか」に合わせて細かく調整できるのが魅力です。今の私の設定は、この「思考の速度でターミナルを操作する」ことを目指した結果、非常にしっくりきています。

もし気になった設定があれば、ぜひ試してみてください。
