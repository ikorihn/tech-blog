---
title: "Neovimã¨VSCode Neovimã§ä½¿ç”¨ã™ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚„è¨­å®šã‚’ä½¿ã„åˆ†ã‘ã‚‹"
emoji: "ğŸ´"
type: "tech"
topics:
  - "vscode"
  - "neovim"
published: true
published_at: "2023-05-14 18:26"
---

ã“ã‚Œã¯ [Vimé§…ä¼](https://vim-jp.org/ekiden/) 5/15 ã®è¨˜äº‹ã§ã™ã€‚

## ã¯ã˜ã‚ã«

ç§ã¯æ™®æ®µ Neovim ã‚’ãƒ¡ã‚¤ãƒ³ã«ã—ã¦ã„ã¾ã™ãŒã€
ä»–ã®äººã¨ç’°å¢ƒã‚’åˆã‚ã›ãŸã„ã¨ããªã© VS Code ã‚‚ã¨ãã©ãä½¿ã£ã¦ã„ã¾ã™ã€‚

Vimã®æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ [VSCodeVim](https://github.com/VSCodeVim/Vim) ã‚’å…¥ã‚Œã¦ã„ã‚‹æ–¹ã‚‚å¤šã„ã¨æ€ã„ã¾ã™ãŒã€Undoã®æŒ™å‹•ãŒä¸å®‰å®šã ã£ãŸã‚Šã‚‚ã£ã•ã‚Šã—ã¦ã„ãŸã‚Šã§ä¸æº€ãŒã‚ã£ãŸãŸã‚ã€ [VSCode Neovim](https://marketplace.visualstudio.com/items?itemName=asvetliakov.vscode-neovim) ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚

ã“ã‚Œã¯ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§NeovimãŒå‹•ä½œã™ã‚‹ãŸã‚ã€å…±é€šã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«(`init.lua`)ãŒåˆ©ç”¨ã§ãã¦ã€Neovimã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚‚å‹•ãã¨ã“ã‚ãŒå¬‰ã—ã„ã®ã§ã™ãŒã€
VS Codeã«ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å‚™ã‚ã£ã¦ã„ã‚‹æ©Ÿèƒ½ã‚„ã€ã†ã¾ãå‹•ä½œã—ãªã„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã€ä¸€éƒ¨ã®optionã‚„è¡çªã™ã‚‹key mappingã¯é™¤å¤–ã—ãŸã„ã§ã™ã€‚

ã“ã®è¨˜äº‹ã§ã¯ã€ãã†ã—ãŸNeovimã¨VSCode Neovimã‚’ä½µç”¨ã—ã¦ã„ã¦ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚„è¨­å®šã‚’ä½¿ã„åˆ†ã‘ãŸã„ï¼ã¨ã„ã†æ–¹å‘ã‘ã«ã€
ç§ãŒè¨­å®šã—ã¦ã†ã¾ãã„ã£ã¦ã„ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ç´¹ä»‹ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚

ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒãƒãƒ¼ã‚¸ãƒ£ã¨ã—ã¦ [packer.nvim](https://github.com/wbthomason/packer.nvim) ã¨[lazy.nvim](https://github.com/folke/lazy.nvim) ã®ãã‚Œãã‚Œã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã™ã€‚

ã¡ãªã¿ã«ç§ã®è¨­å®šã¯ã“ã¡ã‚‰ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚
https://github.com/ikorihn/dotfiles/blob/master/.config/nvim

## packerã®å ´åˆ

`init.lua` ã¨pluginã¯ã“ã¡ã‚‰ã®ã‚ˆã†ã«è¨­å®šã—ã¦ã„ã¾ã™ã€‚

`~/.config/nvim/init.lua`

```lua
require("options")
require("keymaps")
require("plugins")
require("packer_compiled")
```

`~/.config/nvim/lua/plugins.lua`

```lua
local fn = vim.fn

-- Automatically install packer
local install_path = fn.stdpath "data" .. "/site/pack/packer/start/packer.nvim"
if fn.empty(fn.glob(install_path)) > 0 then
  PACKER_BOOTSTRAP = fn.system {
    "git",
    "clone",
    "--depth",
    "1",
    "https://github.com/wbthomason/packer.nvim",
    install_path,
  }
  print "Installing packer close and reopen Neovim..."
end

vim.cmd [[packadd packer.nvim]]

local packer = require("packer")
local util = require("packer.util")
packer.init {
  compile_path = util.join_paths(vim.fn.stdpath('config'), 'lua', 'packer_compiled.lua'),
}

return packer.startup(function(use)
  use { "wbthomason/packer.nvim" }

  -- plugins...

end)

```

### cond ã§ãƒ­ãƒ¼ãƒ‰ã™ã‚‹æ¡ä»¶ã‚’è¨­å®šã™ã‚‹

`cond` ã§ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹æ¡ä»¶ã‚’è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
VS Codeã¨ä½µç”¨ã™ã‚‹ã¨ãã«ã‚ˆãç´¹ä»‹ã•ã‚Œã‚‹ã‚„ã‚Šæ–¹ã¯ã“ã¡ã‚‰ã ã¨æ€ã„ã¾ã™ã€‚

ãŸã¨ãˆã°æ¬¡ã®ã‚ˆã†ã«æ›¸ãã¨ã€VS Codeã®ã¨ãã«ã¯disableã«ã™ã‚‹ã¨ã„ã£ãŸã“ã¨ãŒã§ãã¾ã™ã€‚

```lua
local nocode = function()
  -- VSCode Neovimã®ã¨ãã«ã¯1ãŒè¨­å®šã•ã‚Œã‚‹
  return vim.g.vscode == nil
end

return packer.startup(function(use)
  use { "wbthomason/packer.nvim" }

  use { "phaazon/hop.nvim", config = function() require("hop").setup() end }

  -- vscodeã§ãªã„ã¨ãã ã‘ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
  use { "kylechui/nvim-surround", config = function() require("nvim-surround").setup() end, cond = { nocode } }

end)

```

ã“ã‚Œã«ã¯ä»¥ä¸‹ã®å•é¡ŒãŒã‚ã‚Šã¾ã—ãŸã€‚

- vscodeã®ã¨ãã«ãƒ­ãƒ¼ãƒ‰ã—ãŸããªã„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ä¸€ã¤ãšã¤ã«æ›¸ãå¿…è¦ãŒã‚ã‚Šé¢å€’ãªä¸Šã€æ•°ãŒå¤šã„ã¨ã©ã‚ŒãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹/ã•ã‚Œãªã„ã®ã‹ãŒè¦–èªã—ã¥ã‚‰ã‹ã£ãŸ
- condã‚’æ›¸ãã¨`~/.local/share/nvim/site/pack/packer/opt` ã«ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ãŒã€colorschemeãªã©ä¸€éƒ¨ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’optionalã«ã™ã‚‹ã¨ã€ãƒ­ãƒ¼ãƒ‰ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒãšã‚Œã‚‹ãŸã‚ã‹æ­£ã—ãå‹•ä½œã—ãªã‹ã£ãŸ
    - ä¾‹ [Question: what to use to make plugin inactive if condition Â· Issue #288 Â· wbthomason/packer.nvim](https://github.com/wbthomason/packer.nvim/issues/288)

ãã“ã§ã€æ¬¡ã®ã‚ˆã†ã«ã—ã¦è§£æ±ºã—ã¾ã—ãŸã€‚

### `init.lua` ã§èª­ã¿è¾¼ã‚€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†ã‘ã‚‹

VS Codeã®ã¨ãã ã‘åˆ©ç”¨ã—ãŸã„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚„è¨­å®šã‚’ã‹ã„ãŸãƒ•ã‚¡ã‚¤ãƒ«(`vscode.lua`)ã‚’åˆ¥ã§ä½œã‚Šã€ `init.lua` ã§èª­ã¿è¾¼ã‚€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†ã‘ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

`~/.config/nvim/init.lua`

```lua
-- å…±é€šã®è¨­å®š
require("options")
require("keymaps")

if vim.g.vscode == 1 then
  -- VS Codeç”¨ã®è¨­å®š
  require("vscode")
  return
end

require("plugins")
require("packer_compiled")
```

ã¾ãŸã€VS Codeã®ã¨ãã‚‚packerã‚’ä½¿ã„ãŸã‹ã£ãŸã®ã§ã™ãŒã€ç«¶åˆã—ã¦ã—ã¾ã£ã¦ã†ã¾ãã„ã‹ãªã‹ã£ãŸã®ã§ [vim-plug](https://github.com/junegunn/vim-plug) ã‚’ä½¿ã†ã“ã¨ã«ã—ã¾ã—ãŸã€‚
ã‚¨ãƒ¬ã‚¬ãƒ³ãƒˆãªæ–¹æ³•ã§ã¯ãªã„ã¨æ€ã„ã¾ã™ãŒã€çµå±€ã“ã‚ŒãŒä¸€ç•ªå®‰å®šã—ã¾ã—ãŸã€‚

`~/.config/nvim/lua/vscode.lua`

```lua
-- ~/.local/share/nvim/site/pack/*/start/* ã‚’èª­ã¿è¾¼ã¾ã›ãªã„
vim.opt.packpath:remove(vim.fn.stdpath('data').."/site")

-- Plug
-- Automatically install plug
local plugpath = vim.fn.stdpath("data") .. "/plugged/vim-plug"
if not vim.loop.fs_stat(plugpath) then
  vim.fn.system({
    "curl",
    "-fLo",
    plugpath .. "/autoload/plug.vim",
    "--create-dirs",
    "https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim",
  })
end
vim.opt.rtp:prepend(plugpath)

-- packerã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’åˆ©ç”¨ã™ã‚‹
vim.cmd [[ call plug#begin(stdpath('data') . '/site/pack/packer/start') ]]

vim.cmd [[ Plug 'phaazon/hop.nvim' ]]
vim.cmd [[ Plug 'junegunn/vim-easy-align' ]]
vim.cmd [[ Plug 'jeetsukumaran/vim-indentwise' ]]
vim.cmd [[ Plug 'haya14busa/vim-asterisk' ]]
vim.cmd [[ Plug 'kevinhwang91/nvim-hlslens' ]]
vim.cmd [[ Plug 'kylechui/nvim-surround' ]]

vim.cmd [[ call plug#end() ]]

require("pluginconfig/hop")
require("pluginconfig/nvim-surround")
require("pluginconfig/nvim-hlslens")
```

### packpathã«ã¤ã„ã¦

2è¡Œç›®ã® `vim.opt.packpath:remove(vim.fn.stdpath('data').."/site")` ãŒãƒãƒƒã‚¯ã£ã½ã„ã§ã™ãŒã€ã“ã‚Œã‚’æ›¸ã„ã¦ã„ãªã„ã¨ `vscode.lua` ã«æ›¸ã„ã¦ã„ãªã„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚‚ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚

runtimepathã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€è¿½åŠ ã—ãŸè¦šãˆã®ãªã„ `~/.local/share/nvim/site/pack/*/start/*` ãŒã‚ã‚Šã¾ã™ã€‚

```
:se runtimepath
runtimepath=~/.config/nvim,/opt/homebrew/etc/xdg/nvim,/etc/xdg/nvim,~/.local/share/nvim/site,~/.local/share/nvim/site/pack/*/start/*,...
```

ã“ã‚Œã¯ [packages](https://neovim.io/doc/user/repeat.html#packages) ã®ä»•çµ„ã¿ã«ã‚ˆã£ã¦ [packpath](https://neovim.io/doc/user/options.html#'packpath') ã§æŒ‡å®šã•ã‚ŒãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã«é…ç½®ã•ã‚ŒãŸãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’èµ·å‹•æ™‚ã«èª­ã¿è¾¼ã‚€ãŸã‚ã§ã™ã€‚
ç§ã®ç’°å¢ƒã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã—ãŸã€‚

```
:se packpath
packpath=~/.config/nvim,/opt/homebrew/etc/xdg/nvim,/etc/xdg/nvim,~/.local/share/nvim/site,...
```

packerã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ `vim.fn.stdpath('data')..'/site/pack/packer/start'` ã«ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ã€ã“ã¡ã‚‰ã«ç½®ã‹ã‚ŒãŸãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒVS Codeã§ã‚‚èª­ã¿è¾¼ã¾ã‚Œã¦ã„ãŸã¨ã„ã†ã‚ã‘ã§ã™ã€‚
ãã®ãŸã‚ã€`vim.fn.stdpath('data').."/site"` ã‚’packpathã‹ã‚‰é™¤å¤–ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

## lazyã®å ´åˆ

æœ€è¿‘lazy.nvimã«ç§»è¡Œã—ãŸã®ã§ã€ãã®å ´åˆã®è¨­å®šã‚‚è¼‰ã›ã¦ãŠãã¾ã™ã€‚ã“ã¡ã‚‰ã®ã»ã†ãŒç°¡å˜ã§ã—ãŸã€‚

`~/.config/lua/plugins.lua`

```lua
-- Automatically install lazy
local lazypath = vim.fn.stdpath("data") .. "/lazy/lazy.nvim"
if not vim.loop.fs_stat(lazypath) then
  vim.fn.system({
    "git",
    "clone",
    "--filter=blob:none",
    "https://github.com/folke/lazy.nvim.git",
    "--branch=stable", -- latest stable release
    lazypath,
  })
end
vim.opt.rtp:prepend(lazypath)

local plugins = {
  -- plugins...
  { "nvim-lua/plenary.nvim"  },
}

require('lazy').setup(plugins, {
})
```

lazyã§ã¯packpathé…ä¸‹ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œãªã„ãŸã‚ã€`vscode.lua` ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```diff
--- a/.config/nvim/lua/vscode.lua
+++ b/.config/nvim/lua/vscode.lua
@@ -1,6 +1,3 @@
--- ~/.local/share/nvim/site/pack/*/start/* ã‚’èª­ã¿è¾¼ã¾ã›ãªã„
-vim.opt.packpath:remove(vim.fn.stdpath('data').."/site")
-
 -- Plug
 -- Automatically install plug
 local plugpath = vim.fn.stdpath("data") .. "/plugged/vim-plug"
@@ -15,7 +12,7 @@ if not vim.loop.fs_stat(plugpath) then
 end
 vim.opt.rtp:prepend(plugpath)

-vim.cmd [[ call plug#begin(stdpath('data') .. '/site/pack/packer/start') ]]
+vim.cmd [[ call plug#begin(stdpath('data') .. '/lazy') ]]

 vim.cmd [[ Plug 'phaazon/hop.nvim' ]]
```

ã‚ã‚‹ã„ã¯ã‚‚ã£ã¨ç°¡å˜ã«ã€`vscode.lua` ã«åˆ†ã‘ãšã« `plugins.lua` å†…ã§å®Œçµã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```lua
local plugins;
if vim.g.vscode == 1 then
  plugins = {
    { "phaazon/hop.nvim", config = function() require("pluginconfig/hop") end },
    { "junegunn/vim-easy-align" },
    { "kylechui/nvim-surround", config = function() require("pluginconfig/nvim-surround") end },
  }
else
  -- Neovimã§åˆ©ç”¨ã™ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³
  plugins = {
    { "nvim-lua/plenary.nvim"  },
    { "windwp/nvim-autopairs", config = function() require("pluginconfig/autopairs") end },
  }
end

require('lazy').setup(plugins, {
})
```


## ãŠã‚ã‚Šã«

æ•°ãƒ¶æœˆã»ã©ä½¿ã£ã¦ã„ã¾ã™ãŒã€ä»Šã®ã¨ã“ã‚ç‰¹ã«å•é¡Œã¯ç™ºç”Ÿã›ãšã€å¿…è¦ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã ã‘ã‚’æ´»ã‹ã—ã¦æº€è¶³ã®ã„ãæ“ä½œãŒã§ãã¦ã„ã¾ã™ã€‚

VS Codeã‚’ãƒ¡ã‚¤ãƒ³ã§ä½¿ã£ã¦ã„ã‚‹ãŒã€Vimãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®æ©Ÿèƒ½ã‚’ä½¿ã„ãŸã„ï¼ã¨ã„ã†ã‚ˆã†ãªãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«ã‚‚åˆºã•ã‚Œã°å¹¸ã„ã§ã™ã€‚
